{%extends 'base.html'%}
{% load crispy_forms_tags %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    {% block head %}
    {% load static %}
      <title>Session Detail</title>
    {% endblock %}
  </head>
  <body>
    {% block body %}
    <div class="session_detail_one container-">
      <!-- <div class="session_detail offset-1 col-md-10"> -->
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{message.tags}}">
              <!-- <p>message.tags: {{message.tags}}</p> -->
              <p>{{message}}</p>
              {{condition}}
            </div>
          {% endfor %}
        {% endif %}



          <!-- <h3>{{session_data_dir}}</h3> -->
          <!-- <h3>{{session_wf}}</h3> -->





        <div class="card bg-light mb-3">
          <div class="card-header">Session Identifier: {{session_detail.identifier}}</div>
          <div class="card-body">
            <!-- <h5 class="card-title">Session Identifier: {{session_detail.identifier}}</h5> -->
            <div class="card-text">
              <table class="table mb-0">
                <thead>
                  <tr>
                    <th>Index</th>
                    <th>Organism</th>
                    <th>Salmon</th>
                    <th>DNA Fasta</th>
                    <th>cDNA Fasta</th>
                    <th>GTF</th>
                    <th>Conditions</th>
                    <th>Workflows</th>
                    <th>Workflow Graph</th>
                    <th>Uploaded</th>
                  </tr>
                </thead>
                <tbody>
                    <tr>
                      <td>{{session_detail.genome_index}}</td>
                      <td>{{ session_detail.organism|default_if_none:"" }} {{session_detail.genome.organism}}</td>
                      <td>{{session_detail.salmon}}</td>
                      <td>{{ session_detail.fasta_dna_file }} {{session_detail.genome.fasta_dna_file}}</td>
                      <td>{{ session_detail.fasta_cdna_file }} {{ session_detail.genome.fasta_cdna_file }}</td>
                      <td>{{ session_detail.gtf_file }} {{ session_detail.genome.gtf_file }}</td>
                      <td><a id='id_conditions_create_btn' class='btn btn-sm btn-success' href="{% url 'analysis:conditions_create' session_slug=session_detail.identifier %}">Add Condition</a></td>
                      <td><a id='id_workflow_create_btn' class='btn btn-sm btn-success disabled' href="{% url 'analysis:workflow_create' session_slug=session_detail.identifier %}">Add Workflow</a></td>
                      <td>
                        <!-- Trigger the modal with a button -->
                                <button type="button" class="btn btn-sm btn-info" onclick='svg_delay()' data-toggle="modal" data-target="#myModal">Workflow</button>

                                <!-- Modal -->
                                <div id="myModal" class="modal fade" role="dialog">
                                  <div class="modal-dialog modal-lg">

                                    <!-- Modal content-->
                                    <div class="modal-content">
                                      <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                                        <h1>Workflow</h1>
                                      </div>
                                        {% if session_wf %}
                                        <object id='id_demo_wf' data="{% static 'images/' %}{{session_detail.identifier}}/my-wf.svg" type="image/svg+xml" class="svg">
                                          <!-- <img src="yourfallback.jpg" /> -->
                                        </object>
                                        {% endif %}
                                        {% if not session_wf %}
                                          <h2>Clever stuff happening behind the scenes. Please be patient.</h2>
                                          <div class="container">
                                            <div class="loader spinner"></div>
                                            <div class="icon"></div>
                                          </div>
                                        {% endif %}

                                      <div class="modal-footer">
                                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                      </div>
                                    </div>

                                  </div>
                                </div>
                      </td>
                      <td>{{session_detail.status}}</td>
                    </tr>
                </tbody>
            </table>
            </div>
          </div>
        </div>


        <!-- CONDITIONS -->
        <div id='id_conditions_div'>
        {% if session_detail.conditions_fk.all %}
          <div class='lead'>Session Conditions:</div>
          <table class="table table-bordered bm-2">
            <thead class=''>
              <tr>
                <!-- <th>Key</th> -->
                <th>Num</th>
                <th>Condition</th>
                <th>Replicates</th>
                <th>Add Sample</th>
                <th>Update</th>
                <th>Delete</th>
              </tr>
            </thead>
            <tbody>
                {% for condition in session_detail.conditions_fk.all %}
                <tr>
                  <!-- <td>{{ condition.pk }}</td> -->
                  <td class='td_conditions_counter'>{{forloop.counter}}</td>
                  <td class="td_condition">{{ condition.condition }}</td>
                  <td class="td_replicate">{{ condition.no_replicates }}</td>
                  <td><a class='btn btn-sm btn-success' href="{% url 'analysis:samples_create' session_slug=condition.session.identifier conditions_pk=condition.pk %}">Add Sample</a></td>
                  <td><a class='btn btn-sm btn-warning' href="{% url 'analysis:conditions_update' session_slug=condition.session.identifier conditions_pk=condition.pk %}">Update</a></td>
                  <td><a class='btn btn-sm btn-danger' href="{% url 'analysis:conditions_delete' session_slug=condition.session.identifier conditions_pk=condition.pk %}">Delete</a></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endif %}
        {% if not session_detail.conditions_fk.all %}
          <!-- <h3>No conditions defined.</h3> -->
        {% endif %}
        </div>


<br><br>
      <!-- SAMPLES -->
      <div id='id_samples_div'>
      {% if session_detail.samples_fk.all %}
      <div class='lead'>Session Samples:</div>
      <table class="table table-bordered mb-1">
        <thead>
          <tr>
            <!-- <th>Key</th> -->
            <th>Num</th>
            <th>Libtype</th>
            <th>Condition</th>
            <th style='width: 17%'>Read One</th>
              <th style='width: 17%'>Read Two</th>
            <th>Accession</th>
            <th>Update</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody>
            {% for sample in session_detail.samples_fk.all %}
            <tr>
              <!-- <td>{{ sample.pk }}</td> -->
              <td class='td_samples_counter'>{{forloop.counter}}</td>
              <td class="td_libtype">{{ sample.libtype }}</td>
              <td>{{ sample.condition }}</td>
              <td>{{ sample.read_1 }}</td>
              {% if sample.read_2 %}
                <td>{{ sample.read_2 }}</td>
              {% endif %}
              {% if not sample.read_2 %}
                <td>N/a</td>
              {% endif %}
              <td>{{ sample.accession }}</td>
              <td><a class='btn btn-sm btn-warning' href="{% url 'analysis:samples_update' session_slug=sample.session.identifier samples_pk=sample.pk %}">Update</a></td>
              <td><a class='btn btn-sm btn-danger' href="{% url 'analysis:samples_delete' session_slug=sample.session.identifier samples_pk=sample.pk %}">Delete</a></td>
<!-- session_pk': 2, 'sample_pk': 7
analysis/session_detail/2/samples_update/7/ -->

            </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
      {% if not session_detail.samples_fk.all %}
            <!-- <h3>{{'No samples defined.'}}</h3> -->
      {% endif %}
    </div>

<br><br>
        <!-- WORKFLOW -->
        <div id='id_workflow_div'>
        {% if session_detail.workflow.all %}
        <div class='lead'>Session Workflow:</div>
        <table class="table table-bordered mb-1">
          <thead>
            <tr>
              <!-- <th>Key</th> -->
              <th>Num</th>
              <th>Mapper</th>
              <th>Assembler</th>
              <th>Analysis</th>
              <th>Status</th>
              <th>Update</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody>
            {% for workflow in session_detail.workflow.all %}
            <tr>
              <!-- <td>{{workflow.pk}}</td> -->
              <td class='td_workflow_counter'>{{forloop.counter}}</td>
              <td>{{ workflow.mapper }}</td>
              <td>{{ workflow.assembler }}</td>
              <td>{{ workflow.analysis }}</td>
              <td>{{ workflow.status }}</td>
              <td><a class='btn btn-sm btn-warning' href="{% url 'analysis:workflow_update' session_slug=workflow.session.identifier workflow_pk=workflow.pk %}">Update</a></td>
              <td><a class='btn btn-sm btn-danger' href="{% url 'analysis:workflow_delete' session_slug=workflow.session.identifier workflow_pk=workflow.pk %}">Delete</a></td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
        {% endif %}
        {% if not session_detail.workflow.all %}
          <!-- <h3>No Workflows defined.</h3> -->
        {% endif %}

        <br><br>
      </div>

      <!-- FORM TO CHANGE STATUS OF SESSION TO TRUE -->
      <form method="POST"  enctype="multipart/form-data" id='id_session_submit_btn' class='hidden'>
        {% csrf_token %}
        {{form|crispy}}
        <!-- will need to define individual fields in which case i dont need to use javascript to hide as i can specify fields shown directly! -->
        <br>
        <input type="submit" class='create_btn' value="SUBMIT FOR ANALYSIS">
      </form>
    </div> <!--END session_one_detail  -->

      <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- jQuery cdn is required prior to using bootstrap -->


      <script type="text/javascript" src= "{% static 'js/svg-pan-zoom.min.js' %}"></script>
      <script>


      function svg_delay(){
        console.log('delay')
        setTimeout(function() { zoomSvg(); }, 200);
      }

      function zoomSvg(){
        console.log('called')
        svgPanZoom('#id_demo_wf')
      }

      $( document ).ready(function() {
        $('#id_workflow_create_btn')
        // $('#id_SessionSubmitForm').hide()
        if($('.td_index').length){
          // alert('show samples');
          $('#session_upload').show()
        }
        if($('.td_conditions_counter').length){
          console.log('condition added')
          // $('#id_conditions_create_btn').prop('disabled', true);
          // $('#id_workflow_create_btn').removeClass('disabled')
        }
        if($('.td_samples_counter').length){
          console.log('samples added');
          // $('#id_conditions_create_btn').prop('disabled', true);
          $('#id_workflow_create_btn').removeClass('disabled')
        }
        if($('.td_workflow_counter').length){
          unhide(['id_session_submit_btn'])
        }
    });
    </script>


  {% endblock %}
  </body>
</html>
